---
title: Create a workload cluster in CAPZ
description: This guide will walk you through all necessary steps to create a workload cluster using the cluster API Provider Azure.
weight: 160
menu:
  main:
    parent: getting-started
user_questions:
  - How can I create a workload cluster in a CAPZ environment?
  - How can I get the CAPZ cluster template using kubectl gs template cluster?
aliases:
  - /guides/create-wlcluster-capa-template/
owner:
  - https://github.com/orgs/giantswarm/teams/team-clippy
last_review_date: 2023-04-04
---

### Cluster types

As of now, there are two kind of workload clusters which can be created.

* A **public** cluster, which means that the Kubernetes API is directly exposed to the internet.
* A **private** cluster, where the Kubernetes API is only exposed to an Azure internal network.
To access the Kubernetes API there, a connection must be either established to this internal Azure network or the network of the management cluster itself.

### Prepare configuration

In order to create a workload cluster in an installation using the cluster API Provider Azure you can follow below steps.

All the relevant configuration items will be generated by using `kubectl gs template cluster`. For that a set of input configuration is needed.
The configuration must be passed as file and will be validated against the [remote schema](https://github.com/giantswarm/cluster-azure/blob/main/helm/cluster-azure/values.schema.json) in [cluster-azure](https://github.com/giantswarm/cluster-azure).

#### public cluster

To get a public cluster provisioned, below cluster configuration must be given:

```yaml
# filename: cluster.yaml
metadata:
  name: "jrp45"
  description: "jrp45 test cluster"
  organization: "multi-project"
providerSpecific:
  location: westeurope
  subscriptionId: 6b1f6e4a-6d0e-4aa4-9a5a-fbaca65a4711
```

This will create a workload cluster in the subscription `6b1f6e4a-6d0e-4aa4-9a5a-fbaca65a4711` in Azure region `westeurope`.
As these are the only two defined values for the cluster, all the defaults from the [remote schema](https://github.com/giantswarm/cluster-azure/blob/main/helm/cluster-azure/values.schema.json) will get applied.

As all mandatory Apps a workload cluster needs, are bundled as `default-apps-azure`, a basic configuration must be also given.

```yaml
# filename: default-app.yaml
clusterName: "jrp45"
organization: "multi-project"
```

Given the above files, a configuration can be generated by running

```nohighlight
$ kubectl gs template cluster --provider=capz --cluster-config=cluster.yaml --default-app-config=default-app.yaml --output=generated-manifest.yaml
```

Above command will generate a configuration similar like

```yaml
# filename: generated-manifest.yaml
---
apiVersion: v1
data:
  values: |
    metadata:
      description: jrp45 cluster
      name: jrp45
      organization: multi-project
    providerSpecific:
      location: westeurope
      subscriptionId: 6b1f6e4a-6d0e-4aa4-9a5a-fbaca65a4711
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: jrp45-user-values
  namespace: org-multi-project
---
apiVersion: application.giantswarm.io/v1alpha1
kind: App
metadata:
  labels:
    app-operator.giantswarm.io/version: 0.0.0
  name: jrp45
  namespace: org-multi-project
spec:
  catalog: cluster
  config:
    configMap:
      name: ""
      namespace: ""
    secret:
      name: ""
      namespace: ""
  kubeConfig:
    context:
      name: ""
    inCluster: true
    secret:
      name: ""
      namespace: ""
  name: cluster-azure
  namespace: org-multi-project
  userConfig:
    configMap:
      name: jrp45-user-values
      namespace: org-multi-project
  version: 0.0.16
---
apiVersion: v1
data:
  values: |
    clusterName: jrp45
    organization: multi-project
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: jrp45-default-apps-user-values
  namespace: org-multi-project
---
apiVersion: application.giantswarm.io/v1alpha1
kind: App
metadata:
  labels:
    app-operator.giantswarm.io/version: 0.0.0
  name: jrp45-default-apps
  namespace: org-multi-project
spec:
  catalog: cluster
  config:
    configMap:
      name: "jrp45-cluster-values"
      namespace: "org-multi-project"
    secret:
      name: ""
      namespace: ""
  kubeConfig:
    context:
      name: ""
    inCluster: true
    secret:
      name: ""
      namespace: ""
  name: default-apps-azure
  namespace: org-multi-project
  userConfig:
    configMap:
      name: jrp45-default-apps-user-values
      namespace: org-multi-project
  version: 0.0.13
```

This configuration can be applied by running `kubectl apply`.

```nohighlight
$ kubectl apply -f CONFIGURATION_FROM_ABOVE.yaml
configmap/jrp45-user-values created
app.application.giantswarm.io/jrp45 created
configmap/jrp45-default-apps-user-values created
app.application.giantswarm.io/jrp45-default-apps created
```

It will take a while once the workload cluster got provisioned. The current state can be seen by running `kubectl get cluster,azurecluster` against the management cluster:

```nohighlight
$ kubectl get cluster,azurecluster -o wide
NAME                              PHASE         AGE   VERSION
cluster.cluster.x-k8s.io/jrp45    Provisioned   11m

NAME    CLUSTER   READY   REASON   MESSAGE   RESOURCE GROUP   SUBSCRIPTIONID                         LOCATION     ENDPOINT                                       AGE
jrp45   jrp45     True                       jrp45            6b1f6e4a-6d0e-4aa4-9a5a-fbaca65a4711   westeurope   jrp45-daa6e70e.westeurope.cloudapp.azure.com   11m
```

#### private cluster

To create a private cluster, a few more information are required for a successful cluster creation.
As private clusters are connected to the management cluster via peering, it has to be ensured that now overlapping CIDRs for private clusters are used.

Below command will list all clusters for a given management cluster, their used CIDRs and the apiserver type (useful to differentiate between public and private/internal clusters).

```
$ kubectl get azurecluster -A -o=custom-columns='NAMESPACE:.metadata.namespace,CLUSTER-NAME:.metadata.name,HOST-CIDR:.spec.networkSpec.vnet.cidrBlocks,CONTROLPLANE-CIDR:.spec.networkSpec.subnets[?(@.role=="control-plane")].cidrBlocks,WORKERS-CIDR:.spec.networkSpec.subnets[?(@.role=="node")].cidrBlocks,APISERVER-TYPE:.spec.networkSpec.apiServerLB.type'

NAMESPACE           CLUSTER-NAME   HOST-CIDR         CONTROLPLANE-CIDR   WORKERS-CIDR      APISERVER-TYPE
org-giantswarm      glippy         [10.223.0.0/24]   [10.223.0.128/26]   [10.223.0.0/25]   Public
org-multi-project   jrp45          [10.0.0.0/16]     [10.0.0.0/20]       [10.0.16.0/20]    Public
org-observability   ytc82          [10.223.2.0/24]   [10.223.2.128/27]   [10.223.2.0/25]   Internal
```

> Note: As getting the correct CIDR depend on the installation, please get in contact with your platform team to check for the next CIDR range to use.
>
> This step might became obsolete once a dedicated IPAM operator got implemented for private Azure clusters.

In our case, the next usable CIDR range is `10.223.3.0/24` and therefore the cluster configuration will look like

```yaml
# filename: cluster_private.yaml
metadata:
  name: bzm29
  organization: observability
providerSpecific:
  location: westeurope
  subscriptionId: 6b1f6e4a-6d0e-4aa4-9a5a-fbaca65a4711
connectivity:
  network:
    controlPlane:
      cidr: 10.223.3.128/26
    hostCidr: 10.223.3.0/24
    mode: private
    podCidr: 192.168.0.0/16
    serviceCidr: 172.31.0.0/16
    workers:
      cidr: 10.223.3.0/25
```

This will create a workload cluster in the subscription `6b1f6e4a-6d0e-4aa4-9a5a-fbaca65a4711` in Azure region `westeurope` again.

As all mandatory Apps a workload cluster needs, are bundled as `default-apps-azure`, a basic configuration must be also given.

```yaml
# filename: default-app.yaml
clusterName: "bzm29"
organization: "observability"
```

A validated configuration can be generated by running:

```nohighlight
$ kubectl gs template cluster --provider=capz --cluster-config=cluster_private.yaml --default-app-config=default-app.yaml --output=generated-manifest.yaml
```

Above command will generate the following configuration:

```yaml
# filename: generated-manifest.yaml
---
apiVersion: v1
data:
  values: |
    connectivity:
      network:
        controlPlane:
          cidr: 10.223.3.128/26
        hostCidr: 10.223.3.0/24
        mode: private
        podCidr: 192.168.0.0/16
        serviceCidr: 172.31.0.0/16
        workers:
          cidr: 10.223.3.0/25
    metadata:
      description: bzm29 cluster
      name: bzm29
      organization: observability
    providerSpecific:
      location: westeurope
      subscriptionId: 6b1f6e4a-6d0e-4aa4-9a5a-fbaca65a4711
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: bzm29-user-values
  namespace: org-observability
---
apiVersion: application.giantswarm.io/v1alpha1
kind: App
metadata:
  labels:
    app-operator.giantswarm.io/version: 0.0.0
  name: bzm29
  namespace: org-observability
spec:
  catalog: cluster
  config:
    configMap:
      name: ""
      namespace: ""
    secret:
      name: ""
      namespace: ""
  kubeConfig:
    context:
      name: ""
    inCluster: true
    secret:
      name: ""
      namespace: ""
  name: cluster-azure
  namespace: org-observability
  userConfig:
    configMap:
      name: bzm29-user-values
      namespace: org-observability
  version: 0.0.17
---
apiVersion: v1
data:
  values: |
    clusterName: bzm29
    organization: observability
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: bzm29-default-apps-user-values
  namespace: org-observability
---
apiVersion: application.giantswarm.io/v1alpha1
kind: App
metadata:
  labels:
    app-operator.giantswarm.io/version: 0.0.0
  name: bzm29-default-apps
  namespace: org-observability
spec:
  catalog: cluster
  config:
    configMap:
      name: "bzm29-cluster-values"
      namespace: "org-observability"
    secret:
      name: ""
      namespace: ""
  kubeConfig:
    context:
      name: ""
    inCluster: true
    secret:
      name: ""
      namespace: ""
  name: default-apps-azure
  namespace: org-observability
  userConfig:
    configMap:
      name: bzm29-default-apps-user-values
      namespace: org-observability
  version: 0.0.14
```

It will take a while once the workload cluster got provisioned. The current state can be seen by running `kubectl get cluster,azurecluster` against the management cluster:

```nohighlight
$ kubectl get cluster,azurecluster -o wide
NAME                              PHASE         AGE   VERSION
cluster.cluster.x-k8s.io/bzm29    Provisioned   9m

NAME    CLUSTER   READY   REASON   MESSAGE   RESOURCE GROUP   SUBSCRIPTIONID                         LOCATION     ENDPOINT                                AGE
bzm29   bzm29     True                       bzm29            6b1f6e4a-6d0e-4aa4-9a5a-fbaca65a4711   westeurope   apiserver.bzm29.azuretest.gigantic.io   8m50s
```

### login

Once the cluster got created, `kubectl-gs` could be used to login into the workload cluster by running

```noghighlight
$ kubectl gs login glippy --workload-cluster jrp45 --certificate-group system:masters
```

With the changed context, you are able to list the newly created nodes within a cluster:

```noghighlight
$ kubectl get nodes

NAME                                 STATUS   ROLES           AGE   VERSION
jrp45-control-plane-deb92156-2wsmb   Ready    control-plane   37m   v1.24.11
jrp45-control-plane-deb92156-k57r4   Ready    control-plane   46m   v1.24.11
jrp45-control-plane-deb92156-prp4w   Ready    control-plane   40m   v1.24.11
jrp45-md00-178551d7-5hfn4            Ready    <none>          38m   v1.24.11
jrp45-md00-178551d7-88fk7            Ready    <none>          38m   v1.24.11
jrp45-md00-178551d7-xxrzs            Ready    <none>          38m   v1.24.11
```

### additional notes

The current phase of the provisioning can be also seen by using the [`clusterctl`](https://cluster-api.sigs.k8s.io/user/quick-start.html?highlight=clusterctl#install-clusterctl) command from the upstream ClusterAPI project.
This will give you a more structured and fine-grain overview about current phases of all objects belong to a cluster:

```
$ clusterctl describe cluster jrp45 --show-conditions all
NAME                                           READY  SEVERITY  REASON            SINCE  MESSAGE
Cluster/jrp45                                  True                               117m
│           ├─ControlPlaneInitialized          True                               126m
│           ├─ControlPlaneReady                True                               117m
│           └─InfrastructureReady              True                               127m
├─ClusterInfrastructure - AzureCluster/jrp45   True                               127m
│             ├─LoadBalancersReady             True                               127m
│             ├─NATGatewaysReady               True                               128m
│             ├─NetworkInfrastructureReady     True                               127m
│             ├─PublicIPsReady                 True                               128m
│             ├─ResourceGroupReady             True                               129m
│             ├─RouteTablesReady               True                               128m
│             ├─SecurityGroupsReady            True                               128m
│             ├─SubnetsReady                   True                               127m
│             └─VNetReady                      True                               129m
├─ControlPlane - KubeadmControlPlane/jrp45     True                               117m
│ │           ├─Available                      True                               126m
│ │           ├─CertificatesAvailable          True                               127m
│ │           ├─ControlPlaneComponentsHealthy  True                               119m
│ │           ├─EtcdClusterHealthy             True                               117m
│ │           ├─MachinesCreated                True                               119m
│ │           ├─MachinesReady                  True                               117m
│ │           └─Resized                        True                               117m
│ └─3 Machines...                              True                               126m   See jrp45-4w2w9, jrp45-cx9ll, ...
└─Workers
  └─MachineDeployment/jrp45-md00               True                               90m
    │           └─Available                    True                               90m
    └─3 Machines...                            True                               90m    See jrp45-md00-7b9fb977c8-rzkmw, jrp45-md00-7b9fb977c8-ssjph, ...
```

## Related

- [`kubectl gs login`]({{< relref "/use-the-api/kubectl-gs/login" >}}) - Ensure an authenticated kubectl context.
